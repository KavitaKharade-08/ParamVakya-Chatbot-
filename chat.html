<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Paramvakya — Chat with 3D Avatar</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Model Viewer -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: Inter, sans-serif;
    overflow: hidden;
    background-color: #000;
    display: flex;
  }

  /* ===== Sidebar ===== */
  .sidebar {
    width: 260px;
    background: rgba(20,20,20,0.95);
    color: white;
    height: 100vh;
    display: flex;
    flex-direction: column;
    border-right: 1px solid rgba(255,255,255,0.1);
  }

  .sidebar h2 {
    font-weight: 600;
    text-align: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.15);
  }

  .chat-list {
    flex: 1;
    overflow-y: auto;
  }

  .chat-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    transition: background 0.2s;
  }
  .chat-item:hover {
    background: rgba(255,255,255,0.1);
  }

  .new-chat-btn {
    margin: 1rem;
    padding: 0.75rem;
    background: #4f46e5;
    border-radius: 9999px;
    text-align: center;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  .new-chat-btn:hover {
    background: #6366f1;
  }

  /* ===== Avatar ===== */
  model-viewer#avatarBg {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 40vw;
    height: 80vh;
    z-index: 0;
    background-color: transparent;
    pointer-events: none;
  }

  /* ===== Chat Overlay ===== */
  .chat-overlay {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: transparent;
    position: relative;
    z-index: 2;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    color: #fff;
  }

  .message {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    max-width: 750px;
    margin: 0 auto;
    width: 100%;
  }

  .message.user { justify-content: flex-end; }

  .bubble {
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .bubble.user { background: rgba(99,102,241,0.85); color: #fff; }
  .bubble.bot { background: rgba(0,0,0,0.65); color: #f9fafb; }

  pre {
    background: rgba(0,0,0,0.4);
    padding: 0.75rem;
    border-radius: 0.5rem;
    font-family: monospace;
    font-size: 0.9rem;
    color: #22d3ee;
    overflow-x: auto;
    white-space: pre-wrap;
  }

  .input-area {
    border-top: 1px solid rgba(255,255,255,0.2);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(0,0,0,0.5);
  }

  .inputBox {
    flex: 1;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 1.5rem;
    padding: 0.75rem 1rem;
    background: rgba(255,255,255,0.1);
    color: white;
    outline: none;
  }

  .send-btn {
    background: #4f46e5;
    color: white;
    font-weight: 600;
    padding: 0 18px;
    border-radius: 9999px;
  }

  #micBtn {
    width: 48px;
    height: 48px;
    background-color: rgba(99,102,241,0.8);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.3s ease;
    position: relative;
  }
  #micBtn svg { width: 24px; height: 24px; fill: white; }
  #micBtn.active {
    animation: micPulse 1.3s infinite ease-in-out;
    background-color: rgba(239,68,68,0.8);
  }
  @keyframes micPulse {
    0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); }
    70% { box-shadow: 0 0 0 12px rgba(239,68,68,0); }
    100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
  }
</style>
</head>

<body>
<!-- Sidebar -->
<div class="sidebar">
  <h2>Chats</h2>
  <div id="chatList" class="chat-list"></div>
  <div id="newChatBtn" class="new-chat-btn">+ New Chat</div>
</div>

<!-- Avatar -->
<model-viewer
  id="avatarBg"
  src="https://models.readyplayer.me/68eba1184099d80b93fe1ead.glb"
  alt="Paramvakya Avatar"
  disable-zoom
  autoplay
  camera-controls
  camera-orbit="0deg 95deg 6.5m"
  camera-target="0m 1.1m 0m"
  field-of-view="35deg"
  environment-image="neutral"
  shadow-intensity="1"
></model-viewer>

<!-- Chat Area -->
<div class="chat-overlay">
  <div id="messages">
    <div class="text-gray-300 text-center">Start chatting with Paramvakya...</div>
  </div>

  <div class="input-area">
    <input id="userInput" class="inputBox" placeholder="Type your message..." />
    <button id="micBtn" title="Toggle mic">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 18h2v3h-2z"/>
      </svg>
    </button>
    <button id="sendBtn" class="send-btn">Send</button>
  </div>
</div>

<script>
const messages = document.getElementById('messages');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const chatList = document.getElementById('chatList');
const newChatBtn = document.getElementById('newChatBtn');
const avatar = document.getElementById('avatarBg');

let currentChatId = localStorage.getItem('currentChat') || Date.now().toString();
let chats = JSON.parse(localStorage.getItem('chats') || '{}');
if (!chats[currentChatId]) chats[currentChatId] = [];

function saveChats() {
  localStorage.setItem('chats', JSON.stringify(chats));
  localStorage.setItem('currentChat', currentChatId);
  renderChatList();
}

/* === Render Chat List === */
function renderChatList() {
  chatList.innerHTML = '';
  Object.keys(chats).reverse().forEach(id => {
    const title = chats[id][0]?.text?.slice(0, 25) || 'New Chat';
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.textContent = title;
    div.onclick = () => loadChat(id);
    chatList.appendChild(div);
  });
}

/* === Load Selected Chat === */
function loadChat(id) {
  currentChatId = id;
  messages.innerHTML = '';
  (chats[id] || []).forEach(m => {
    // 🧠 Don't re-save already existing messages
    const msgClass = m.sender === 'user' ? 'user' : 'bot';
    const html = `<div class="message ${msgClass}"><div class="bubble ${msgClass}">${m.text}</div></div>`;
    messages.insertAdjacentHTML('beforeend', html);
  });
  messages.scrollTop = messages.scrollHeight;
  saveChats();
}

/* === Append Message === */
function appendMessage(text, sender = 'bot', save = true) {
  const msgClass = sender === 'user' ? 'user' : 'bot';
  const html = `<div class="message ${msgClass}"><div class="bubble ${msgClass}">${text}</div></div>`;
  messages.insertAdjacentHTML('beforeend', html);
  messages.scrollTop = messages.scrollHeight;

  if (save) {
    chats[currentChatId].push({ text, sender });
    saveChats();
  }
}

/* === Send Message (text or voice) === */
async function sendMessage(isVoiceInput = false) {
  const message = userInput.value.trim();
  if (!message) return;
  appendMessage(message, 'user');
  userInput.value = '';

  appendMessage('⏳ Thinking...', 'bot', false);

  try {
    const API_BASE = window.location.hostname.includes('localhost')
  ? 'http://localhost:3000'
  : 'https://paramvakya-chatbot.onrender.com';

const res = await fetch(`${API_BASE}/chat`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ message })
});
    const data = await res.json();

    messages.lastChild.remove(); // remove "Thinking..."
    const reply = data.reply || 'Sorry, something went wrong.';
    appendMessage(reply, 'bot');

    // 🎙️ Speak only for voice input
    if (isVoiceInput) {
      const utter = new SpeechSynthesisUtterance(reply);
      utter.lang = 'en-US';
      utter.voice = speechSynthesis.getVoices().find(v => v.name.includes("Female") || v.name.includes("Google US English")) || null;
      utter.rate = 1;
      utter.pitch = 1.1;
      speechSynthesis.speak(utter);
    }

  } catch (err) {
    messages.lastChild.remove();
    appendMessage('⚠️ Error contacting server.', 'bot');
  }
}

/* === New Chat === */
newChatBtn.addEventListener('click', () => {
  currentChatId = Date.now().toString();
  chats[currentChatId] = [];
  messages.innerHTML = '<div class="text-gray-300 text-center">Start chatting with Paramvakya...</div>';
  saveChats();
});

/* === Avatar subtle idle motion === */
let angle = 0;
setInterval(() => {
  angle += 0.5;
  avatar.setAttribute('camera-orbit', `${Math.sin(angle / 15) * 3}deg 90deg 3m`);
}, 1200);

/* === Mic Recognition === */
let recognition;
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-US';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = () => {
    micBtn.classList.add('active');
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript.trim();
    userInput.value = transcript;
    sendMessage(true); // ✅ Voice → voice + text
  };

  recognition.onend = () => {
    micBtn.classList.remove('active');
  };
}

micBtn.addEventListener('click', () => {
  if (!recognition) {
    alert('Speech recognition not supported in this browser.');
    return;
  }
  if (micBtn.classList.contains('active')) {
    recognition.stop();
  } else {
    recognition.start();
  }
});

/* === Send Button + Enter Key === */
sendBtn.addEventListener('click', () => sendMessage(false));
userInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendMessage(false);
});

/* === Init === */
renderChatList();
loadChat(currentChatId);
</script>


</body>
</html>


